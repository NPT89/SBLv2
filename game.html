<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suppa Business League - Spill</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
			font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #F5F7FA;
			min-height: 100vh;
			padding: 1rem;
		}
 
		.header {
			background: white;
			backdrop-filter: none;
			border-radius: 12px;
			padding: 1.5rem;
			margin-bottom: 1.5rem;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
			border: 1px solid #E5E7EB;
		}

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .player-info h2 {
			color: #00A89E;
			font-size: 1.5rem;
			margin-bottom: 0.25rem;
		}

        .player-info p {
            color: #666;
            font-size: 0.95rem;
        }

        .logout-btn {
			padding: 0.5rem 1rem;
			background: #EF4444;
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.3s ease;
		}

        .logout-btn:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .countdown-container {
			background: linear-gradient(135deg, #00A89E, #00C4B4);
			padding: 1.5rem;
			border-radius: 12px;
			text-align: center;
			color: white;
		}

        .countdown-container.warning {
			background: linear-gradient(135deg, #EF4444, #F87171);
			animation: pulse 1s infinite;
		}

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .countdown-container h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .countdown-timer {
            font-size: 2.5rem;
            font-weight: 900;
            font-family: 'Courier New', monospace;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .session-content {
			background: white;
			backdrop-filter: none;
			border-radius: 12px;
			padding: 2rem;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
			border: 1px solid #E5E7EB;
		}

        .session-content.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .session-title {
			font-size: 2rem;
			color: #111827;
			margin-bottom: 1rem;
			text-align: center;
			font-weight: 700;
		}

        .session-intro {
			background: #EFF6FF;
			padding: 1.5rem;
			border-radius: 12px;
			margin-bottom: 2rem;
			border-left: 4px solid #3B82F6;
		}

        .session-intro p {
            color: #333;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .result-box {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-box.positive {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .result-box.negative {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .result-icon {
            font-size: 3rem;
        }

        .result-title {
            flex-grow: 1;
        }

        .result-title h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .result-title .your-choice {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }

        .result-narrative {
            color: #333;
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            font-style: italic;
        }

        .result-amount {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 900;
            font-family: 'Courier New', monospace;
        }

        .result-amount.positive {
            color: #28a745;
        }

        .result-amount.negative {
            color: #dc3545;
        }

        .result-instruction {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 0.95rem;
            color: #555;
        }

        .result-instruction strong {
            color: #333;
        }

        .tasks-section {
            margin-bottom: 2rem;
        }

        .tasks-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .task-item {
			background: #F9FAFB;
			padding: 1rem;
			margin-bottom: 0.75rem;
			border-radius: 10px;
			border-left: 4px solid #00A89E;
			display: flex;
			align-items: start;
			gap: 0.75rem;
		}

		.task-number {
			background: #00A89E;
			color: white;
			width: 30px;
			height: 30px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: bold;
			flex-shrink: 0;
		}

        .task-content {
            flex-grow: 1;
        }

        .task-content h4 {
            color: #333;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .task-content p {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .choices-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e0e0e0;
        }

        .choices-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            text-align: center;
        }

        .choice-item {
			background: white;
			padding: 1.5rem;
			margin-bottom: 1rem;
			border-radius: 12px;
			border: 2px solid #E5E7EB;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.choice-item:hover {
			border-color: #00A89E;
			transform: translateX(5px);
			box-shadow: 0 4px 12px rgba(0, 168, 158, 0.15);
		}

		.choice-item.selected {
			border-color: #00A89E;
			background: #F0FDFA; 
		}

        .choice-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .choice-letter {
			background: #00A89E; 
			color: white;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 900;
			font-size: 1.2rem;
		}

        .choice-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .choice-details {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
            padding-left: 3.5rem;
        }

        .submit-btn {
			width: 100%;
			padding: 1.2rem;
			background: #00A89E;
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 1.1rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			margin-top: 2rem;
		}

        .submit-btn:hover:not(:disabled) {
			background: #008A82;
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0, 168, 158, 0.25);
		}

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .waiting-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .waiting-screen h2 {
            color: #00A651;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .waiting-screen p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 0.75rem;
        }

        .waiting-screen .status {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
            border: 2px solid #ffc107;
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .countdown-timer {
                font-size: 2rem;
            }

            .session-title {
                font-size: 1.5rem;
            }
        }
		
		.task-item.collapsible {
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.task-item.collapsible:hover {
			background: #e8f4f8;
			transform: translateX(3px);
		}

		.task-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
		}

		.task-toggle {
			font-size: 0.9rem;
			color: #3B82F6;
			transition: transform 0.3s ease;
			margin-left: 1rem;
		}

		.task-toggle.open {
			transform: rotate(180deg);
		}

		.task-details {
			margin-top: 0.5rem;
			padding-top: 0.5rem;
			border-top: 1px solid #e0e0e0;
		}

		.task-content h4 {
			margin: 0;
		}
		
		.balance-table {
			width: 100%;
			border-collapse: collapse;
			margin: 1rem 0;
			font-size: 0.95rem;
			background: white;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}

		.balance-table thead {
			background: #00A89E;
			color: white;
		}

		.balance-table th {
			padding: 0.75rem;
			text-align: left;
			font-weight: 600;
		}

		.balance-table tbody tr {
			border-bottom: 1px solid #e5e7eb;
		}

		.balance-table tbody tr:hover {
			background: #f9fafb;
		}

		.balance-table tbody tr.separator-row {
			background: #f5f5f5;
			border-top: 2px solid #00A89E;
			border-bottom: 2px solid #00A89E;
		}

		.balance-table td {
			padding: 0.75rem;
		}

		.balance-table td strong {
			color: #00A89E;
		}

		.leaderboard-sticky {
		    background: white;
		    border-radius: 12px;
		    margin-bottom: 1.5rem;
		    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
		    overflow: hidden;
			
		}
		
		.leaderboard-mini {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 1rem 1.5rem;
		    cursor: pointer;
		    transition: background 0.2s;
		}
		
		.leaderboard-mini:hover {
		    background: #f8f9fa;
		}
		
		.leaderboard-mini-left {
		    display: flex;
		    align-items: center;
		    gap: 1rem;
		}
		
		.leaderboard-mini-leader {
		    font-weight: 600;
		    color: #333;
		}
		
		.leaderboard-mini-you {
		    background: #f0f0f0;
		    color: #333;
		    padding: 0.4rem 1rem;
		    border-radius: 20px;
		    font-weight: 600;
		}
		
		.leaderboard-toggle {
		    color: #666;
		    font-size: 1.2rem;
		    transition: transform 0.3s;
		}
		
		.leaderboard-sticky.open .leaderboard-toggle {
		    transform: rotate(180deg);
		}
		
		.leaderboard-full {
		    max-height: 0;
		    overflow: hidden;
		    transition: max-height 0.3s ease;
		}
		
		.leaderboard-sticky.open .leaderboard-full {
		    max-height: 400px;
		    border-top: 1px solid #eee;
		    padding: 1rem;
		    overflow-y: auto;
		}
		
		.leaderboard-item {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 0.6rem 1rem;
		    margin-bottom: 0.4rem;
		    background: #f8f9fa;
		    border-radius: 8px;
		    border-left: 4px solid #00A651;
		}
		
		.leaderboard-item.top3 {
		    background: linear-gradient(135deg, #fff9e6, #fff3cd);
		    border-left-color: #ffc107;
		}
		
		.leaderboard-item.me {
		    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
		    border-left-color: #00A651;
		}
		
		.leaderboard-rank {
		    font-size: 1.2rem;
		    font-weight: 900;
		    color: #00A651;
		    min-width: 35px;
		}
		
		.leaderboard-info {
		    flex-grow: 1;
		    margin-left: 0.75rem;
		}
		
		.leaderboard-info strong {
		    display: block;
		    color: #333;
		    font-size: 0.95rem;
		}
		
		.welcome-overlay {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: rgba(0, 0, 0, 0.7);
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    z-index: 1000;
		}
		
		.welcome-popup {
		    background: white;
		    border-radius: 20px;
		    padding: 2.5rem;
		    max-width: 500px;
		    margin: 1rem;
		    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
		    animation: popIn 0.3s ease-out;
		}
		
		@keyframes popIn {
		    from {
		        opacity: 0;
		        transform: scale(0.9);
		    }
		    to {
		        opacity: 1;
		        transform: scale(1);
		    }
		}
		
		.welcome-popup h2 {
		    color: #00A651;
		    margin-bottom: 1rem;
		    font-size: 1.8rem;
		}
		
		.welcome-popup p {
		    color: #333;
		    line-height: 1.7;
		    margin-bottom: 1rem;
		}
		
		.welcome-popup ul {
		    margin: 1rem 0;
		    padding-left: 1.5rem;
		}
		
		.welcome-popup li {
		    margin-bottom: 0.5rem;
		    color: #555;
		}
		
		.welcome-popup .btn {
		    width: 100%;
		    padding: 1rem;
		    background: linear-gradient(135deg, #00A651, #3B82F6);
		    color: white;
		    border: none;
		    border-radius: 10px;
		    font-size: 1.1rem;
		    font-weight: 600;
		    cursor: pointer;
		    margin-top: 1rem;
		}
		
		.welcome-popup .btn:hover {
		    transform: translateY(-2px);
		    box-shadow: 0 5px 20px rgba(0, 166, 81, 0.3);
		}
		
    </style>
</head>
<body>
	<div class="welcome-overlay" id="welcomeOverlay" style="display: none;">
	    <div class="welcome-popup">
	        <h2>üèÜ Velkommen til Suppa Business League!</h2>
	        <p>Du skal n√• f√∏re regnskap for din egen bedrift i <strong>Tripletex</strong>.</p>
	        <p><strong>Slik gj√∏r du:</strong></p>
	        <ul>
	            <li>G√• til <strong>tripletex.no</strong> og logg inn med e-posten din</li>
	            <li>Gj√∏r oppgavene du ser p√• skjermen</li>
	            <li>Jo flere oppgaver du fullf√∏rer, jo mer tjener bedriften din</li>
	        </ul>
	        <p>üí° St√•r du fast? Bruk <strong>Support</strong> og <strong>AI-assistenten</strong> i Tripletex!</p>
	        <button class="btn" onclick="closeWelcome()">Jeg er klar! üöÄ</button>
	    </div>
	</div>
	
    <div class="container">
        <div class="header">
            <div class="header-top">
				<div class="player-info">
					<h2 id="playerName">Laster...</h2>
					<p id="playerCompany">-</p>
					<p id="playerBalance" style="font-weight: 600; color: #00A651; margin-top: 0.5rem;">üí∞ Saldo: <span id="balanceAmount">-</span></p>
				</div>
				<button class="logout-btn" onclick="logout()">Logg ut</button>
			</div>

			<div class="leaderboard-sticky" id="leaderboardSticky" onclick="toggleLeaderboard()">
			    <div class="leaderboard-mini">
			        <div class="leaderboard-mini-left">
			            <span>üèÜ</span>
			            <span class="leaderboard-mini-leader" id="leaderboardLeader">#1 Laster...</span>
			        </div>
			        <div class="leaderboard-mini-you" id="leaderboardYou">Du: --</div>
			        <div class="leaderboard-toggle">‚ñº</div>
			    </div>
			    <div class="leaderboard-full" id="leaderboardFull"></div>
			</div>

            <div class="countdown-container" id="countdownContainer">
                <h3>‚è∞ Tid igjen til √∏kt <span id="sessionNumber">1</span> stenger:</h3>
                <div class="countdown-timer" id="countdownTimer">--:--:--</div>
            </div>
        </div>

        <div class="session-content" id="sessionContent">
            <!-- Content lastes dynamisk her -->
        </div>
    </div>

    <script>
        //
        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbwiBt51BJNbOqPbpoNzO75Qi3koCHkN7knIy-K1MKYxqybSDiFtPE4qr_rqN2IfiAZAfg/exec';
        
        //
        function jsonpRequest(url, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    const scriptTag = document.getElementById(callbackName);
                    if (scriptTag && scriptTag.parentNode) scriptTag.parentNode.removeChild(scriptTag);
                    resolve(data);
                };
                const queryParams = new URLSearchParams(params);
                queryParams.append('callback', callbackName);
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = `${url}?${queryParams.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    const scriptTag = document.getElementById(callbackName);
                    if (scriptTag && scriptTag.parentNode) scriptTag.parentNode.removeChild(scriptTag);
                    reject(new Error('Failed to load'));
                };
                document.body.appendChild(script);
            });
        }
        
        // Global state
        let currentPlayer = null;
        let sessionData = null;
        let countdownInterval = null;

        // Deadlines - will be fetched from Sheets
        let DEADLINES = {
            1: null,
            2: null,
            3: null
        };

        // Session content data
const SESSIONS = {
    1: {
        title: '√òkt 1: Oppstart',
        intro: '<strong>Gratulerer! Suppa Ventures har investert 250 000 kr i bedriften din.</strong><br><br>Kravet? Du f√∏rer regnskapet selv i Tripletex. Men du har en backup - regnskapsf√∏reren tar det du ikke rekker. Problemet? Han er ikke billig.<br><br>üìã <strong>Slik fungerer det:</strong><br>‚Ä¢ <strong>Systemoppgaver:</strong> Gj√∏r du dem ikke, fakturerer regnskapsf√∏reren deg<br>‚Ä¢ <strong>Inntektsoppgaver:</strong> Fullf√∏r dem for √• tjene penger til bedriften<br>‚Ä¢ <strong>Vinneren:</strong> H√∏yest selskapsverdil etter 3 √∏kter<br><br>üí° <strong>Tips:</strong> Bruk Tripletex sin Support og AI-assistent om du st√•r fast!',
        tasks: [
            {
                title: 'Opprett √•pningsbalanse',
                type: 'table',
                reward: 0,
                penalty: 8000,
                desc: 'Opprett en √•pningsbalanse som balanserer per 01/01-25.',
                tableData: [
                    { account: '1920', description: 'Bankinnskudd', amount: '250 000', side: 'debet' },
                    { account: '', description: '---', amount: '---', side: '' },
                    { account: '2000', description: 'Aksjekapital', amount: '30 000', side: 'kredit' },
                    { account: '2020', description: 'Overkurs', amount: '220 000', side: 'kredit' }
                ]
            },
            {
                title: 'F√∏r din f√∏rste leverand√∏rfaktura',
                type: 'text',
                reward: 0,
                penalty: 2000,
                desc: '<strong>Uhellet er ute! üí∏</strong><br><br>Det har kommet en faktura i posten fra "Nordic IT Solutions AS" p√• 12 500 kr inkl. MVA for "systemlisenser og oppsett."<br><br>Problemet? Du husker ikke √• ha bestilt noe fra dem, og fakturabel√∏pet virker mistenkelig h√∏yt. Kontaktperson p√• fakturaen svarer ikke p√• telefon.<br><br>Regnskapsf√∏reren din sier: "Registrer den uansett - vi m√• ha kontroll p√• hva som kommer inn. Men ikke betal f√∏r du har unders√∏kt!"<br><br><strong>Oppgave:</strong> Bokf√∏r leverand√∏rfakturaen.'
            },
            {
                title: 'Inntektsbilag',
                type: 'text',
                reward: 7500,
                penalty: 0,
                desc: '<strong>Ping! Ny e-post üìß</strong><br><br>"Hei! Har n√• endelig betalt fakturaen fra september - beklager at det tok tid!"<br><br>Du sjekker banken - joda, 7 500 kr har kommet inn. Men fakturaen ble sendt fra det gamle regnskapssystemet ditt f√∏r du gikk over til Tripletex, s√• den finnes ikke her.<br><br><strong>Oppgave:</strong> Bokf√∏r et inntektsbilag og registrer betalingen p√• 7 500 kr i Tripletex.'
            },
            {
                title: 'Opprett din f√∏rste kunde',
                type: 'text',
                reward: 0,
                penalty: 2000,
                desc: '<strong>Din f√∏rste kunde! üéâ</strong><br><br>Telefonen ringer. "Hei, vi har h√∏rt gode ting om dere! Vi trenger hjelp med et kritisk prosjekt - kan dere ta det?"<br><br>Endelig! Din f√∏rste ordentlige kunde. Men f√∏r du kan fakturere m√• du f√• dem inn i systemet.<br><br><strong>Oppgave:</strong> Opprett kunden i Tripletex med navn og kontaktinfo.'
            },
            {
                title: 'Din f√∏rste faktura',
                type: 'text',
                reward: 20000,
                penalty: 5000,
                desc: '<strong>P√• tide √• fakturere! üí∞</strong><br><br>Kunden trenger umiddelbart hjelp med et kritisk prosjekt.<br><br>"Vi betaler hva som helst for √• f√• dette p√• plass," sa de. "Men s√∏rg for at fakturaen er korrekt - vi har droppet leverand√∏rer som rotet med MVA."<br><br>Regnskapsf√∏reren minner deg p√•: "Husk √• sette opp fakturamal med logo f√∏rst - f√∏rsteinntrykket teller!"<br><br><strong>Oppgave del 1:</strong> Last opp logo og tilpass fakturamal med selskapsinfo.<br><br><strong>Oppgave del 2:</strong> Aktiver muligheten for √• bruke MVA-koder.<br><br><strong>Oppgave del 3:</strong> Send faktura p√• 25 000 kr inkl. mva.'
            }
        ],
        choices: []
    },
    2: {
        title: '√òkt 2: Drift',
        intro: 'Bedriften er i gang! N√• skal du h√•ndtere ansatte, prosjekter og reiser.<br><br>üí° <strong>Tips:</strong> Bruk Tripletex sin Support og AI-assistent om du st√•r fast!',
        tasks: [
            {
                title: 'Opprett ansatt',
                type: 'text',
                reward: 0,
                penalty: 5000,
                desc: '<strong>Du trenger hjelp! üëî</strong><br><br>Du klarer ikke alt selv lenger. Heldigvis har du funnet den perfekte kandidaten - en konsulent som kan ta unna kundeprosjektene.<br><br>"N√•r kan jeg begynne?" sp√∏r den nyansatte ivrig.<br><br><strong>Oppgave:</strong> Opprett en fastl√∏nnet ansatt i Tripletex:<br>‚Ä¢ Startdato 01/12-25 kr<br><br>‚Ä¢ Fast m√•nedsl√∏nn: 45 000 kr<br>‚Ä¢ Legg inn skattekort (Prosentkort, 34%)'
            },
            {
                title: 'Opprett prosjekt',
                type: 'text',
                reward: 0,
                penalty: 2000,
                desc: '<strong>Kunden fra √∏kt 1 er forn√∏yd! üéâ</strong><br><br>"Vi vil gjerne fortsette samarbeidet. Kan dere sende noen for √• planlegge fase 2?"<br><br>Din ansatte tar oppdraget. Men f√∏rst trenger du struktur p√• prosjektet.<br><br><strong>Oppgave:</strong> Opprett et timeprisprosjekt for kunden:<br>‚Ä¢ Prosjekttype: Fast timepris<br>‚Ä¢ Timepris: 750 kr'
            },
            {
			    title: 'Reiseregning',
			    type: 'text',
			    reward: 0,
			    penalty: 3000,
			    desc: '<strong>Telefon fra Bilen üì±</strong><br><br>Din ansatte ringer med stresset stemme: "M√∏tet gikk kjempebra! Hotellet kostet en formue, og jeg m√•tte kj√∏re hele veien..."<br><br>"Kan du hjelpe meg f√• orden p√• dette?"<br><br><strong>Oppgave:</strong> F√∏r reiseregning knyttet til prosjektet:<br>‚Ä¢ Kostgodtgj√∏relse: Overnatting over 12 timer - innland<br>‚Ä¢ Hotell: Quality Hotel Prinsen, Trondheim<br>‚Ä¢ Kj√∏ring: 500 km<br>‚Ä¢ Godkjenn reiseregningen'
			},
            {
			    title: 'Timef√∏ring og viderefakturering',
			    type: 'text',
			    reward: 30000,
			    penalty: 0,
			    desc: '<strong>Fakturerbart arbeid! üíµ</strong><br><br>Din ansatte har levert varene. 40 timer med solid konsulentarbeid - og kunden er forn√∏yd.<br><br>"Kan vi f√• fakturaen ASAP? Budsjettet m√• lukkes denne m√•neden," skriver kunden.<br><br><strong>Oppgave:</strong><br>‚Ä¢ F√∏r 40 timer √† 750 kr/time p√• prosjektet<br>‚Ä¢ Fakturer timer og reisekostnader til kunden'
			}
        ],
        choices: []
    },
    3: {
        title: '√òkt 3: M√•nedsavslutning',
        intro: 'Siste √∏kt! N√• skal du kj√∏re l√∏nn, sette opp abonnementer og avslutte m√•neden.<br><br>üí° <strong>Tips:</strong> Bruk Tripletex sin Support og AI-assistent om du st√•r fast!',
        tasks: [
            {
                title: 'L√∏nnskj√∏ring',
                type: 'text',
                reward: 0,
                penalty: 8000,
                desc: '<strong>Det er l√∏nningsdag! üí∞</strong><br><br>Din ansatte stikker hodet inn p√• kontoret: "Hei sjef, l√∏nn i dag?"<br><br>Jada - du er kanskje ny p√• dette, men ansatte som ikke f√•r l√∏nn blir fort eks-ansatte.<br><br><strong>Oppgave:</strong><br>‚Ä¢ Opprett l√∏nnskj√∏ring for den ansatte<br>‚Ä¢ Kontroller at skatt er korrekt<br>‚Ä¢ Godkjenn og utbetal l√∏nn'
            },
			{
			    title: 'Reverser feilfaktura',
			    type: 'text',
			    reward: 0,
			    penalty: 2000,
			    desc: '<strong>Mysterie l√∏st! üîç</strong><br><br>Husker du den mistenkelige fakturaen fra Nordic IT Solutions AS i √∏kt 1? Du har endelig f√•tt tak i noen - og det viser seg at fakturaen var sendt til feil firma. Den skulle aldri v√¶rt til deg.<br><br><strong>Oppgave:</strong> Reverser fakturaen.'
			},
            {
			    title: 'Abonnementsfakturering',
			    type: 'text',
			    reward: 23000,
			    penalty: 0,
			    desc: '<strong>Kunden vil ha fast avtale! üîÑ</strong><br><br>Etter kundebes√∏ket er kunden str√•lende forn√∏yd. De ringer deg: "Vi vil ha en fast avtale - slipper √• tenke p√• det hver m√•ned!"<br><br>Sett opp abonnementer:<br><br><strong>ABONNEMENT 1: Serviceavtale</strong><br>‚Ä¢ Opprett produkt: 15 000 kr inkl. MVA<br>‚Ä¢ M√•nedlig fakturering, 12 m√•neder<br>‚Ä¢ Startdato: 01.09.2025<br><br><strong>ABONNEMENT 2: Supportavtale</strong><br>‚Ä¢ Opprett produkt: 8 000 kr ekskl. MVA<br>‚Ä¢ M√•nedlig fakturering, 6 m√•neder<br>‚Ä¢ Startdato: 01.10.2025<br><br><strong>Oppgave:</strong> Opprett produktene og sett opp abonnementene for kunden.'
			},
            {
                title: 'Bankavstemming og periodeavslutning',
                type: 'text',
                reward: 0,
                penalty: 5000,
                desc: '<strong>M√•neden er over! üìä</strong><br><br>"F√∏r vi kan lukke m√•neden m√• banken v√¶re avstemt," sa regnskapsf√∏reren.<br><br><strong>Oppgave:</strong><br>‚Ä¢ Avstem bankkontoen<br>‚Ä¢ L√•s perioden for m√•neden'
            }
        ],
        choices: []
    }
};

        
        // Initialize
        window.addEventListener('load', async function() {
            
            const playerCompany = localStorage.getItem('suppa_current_player');
            
            if (!playerCompany) {
                window.location.href = 'suppa-express.html';
                return;
            }

            // Show loading state
            document.getElementById('playerName').textContent = 'Laster...';
            document.getElementById('countdownTimer').textContent = 'Laster...';

            try {
                const deadlinesData = await jsonpRequest(SHEETS_API_URL, { action: 'getDeadlines' });
                if (deadlinesData.status === 'success') {
                    DEADLINES = {
                        1: new Date(deadlinesData.deadlines[1]).getTime(),
                        2: new Date(deadlinesData.deadlines[2]).getTime(),
                        3: new Date(deadlinesData.deadlines[3]).getTime()
                    };
                }

                const playerData = await jsonpRequest(SHEETS_API_URL, { 
                    action: 'getPlayer', 
                    company: playerCompany 
                });
                
                if (playerData.status === 'success') {
					currentPlayer = playerData.data;
					document.getElementById('playerName').textContent = currentPlayer.name;
					document.getElementById('playerCompany').textContent = currentPlayer.company;
					document.getElementById('sessionNumber').textContent = currentPlayer.currentSession;

					showWelcomePopup();
					
					updateBalanceDisplay(); 

					// Load session
					loadSession(currentPlayer.currentSession);

                    // Start countdown
                    startCountdown(currentPlayer.currentSession);
                    
                } else {
                    throw new Error('Spillerdata ikke funnet');
                }
                
            } catch (error) {
                console.error('‚ùå FEIL ved lasting:', error);
                console.error('‚ùå Error type:', error.constructor.name);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                
                // Clear localStorage to prevent loop
                localStorage.removeItem('current_player');
                localStorage.removeItem('player_name');
                window.location.href = 'suppa-express.html';
            }
        });

        function loadSession(sessionNum) {
            const session = SESSIONS[sessionNum];
            const deadline = DEADLINES[sessionNum];
            const now = Date.now();

            const contentDiv = document.getElementById('sessionContent');

            // Check if session is closed
            if (now > deadline) {
                showWaitingScreen(sessionNum);
                return;
            }

            // Build result box if session 2 or 3
            let resultHtml = '';
            if (sessionNum === 2 || sessionNum === 3) {
                const previousSession = sessionNum - 1;
                const previousChoice = currentPlayer[`session${previousSession}Choice`];
                
                if (previousChoice) {
                    // Get result - for now simulate with random outcome
                    // TODO: Later this will be fetched from Google Sheets based on admin's decision
                    const result = getResultForChoice(previousSession, previousChoice);
                    
                    if (result) {
                        const resultClass = result.amount > 0 ? 'positive' : result.amount < 0 ? 'negative' : '';
                        const amountClass = result.amount > 0 ? 'positive' : result.amount < 0 ? 'negative' : '';
                        const amountPrefix = result.amount > 0 ? '+' : '';
                        
                        resultHtml = `
                            <div class="result-box ${resultClass}">
                                <div class="result-header">
                                    <div class="result-icon">${result.icon}</div>
                                    <div class="result-title">
                                        <h3>${result.title}</h3>
                                        <div class="your-choice">Ditt valg fra √∏kt ${previousSession}: Alternativ ${previousChoice}</div>
                                    </div>
                                </div>
                                <div class="result-narrative">
                                    ${result.narrative}
                                </div>
                                <div class="result-amount ${amountClass}">
                                    ${amountPrefix}${result.amount.toLocaleString('no-NO')} NOK
                                </div>
                                <div class="result-instruction">
                                    <strong>üìù Bokf√∏ringsoppgave:</strong> ${result.booking}
                                </div>
                            </div>
                        `;
                    }
                }
            }

            // Show session content
            let html = `
                <h1 class="session-title">${session.title}</h1>
                <div class="session-intro">
                    <p>${session.intro}</p>
                </div>

                ${resultHtml}

                <div class="tasks-section">
					<h3>üìã Oppgaver i Tripletex</h3>
					${session.tasks.map((task, i) => {
						let taskContent = '';
						
						if (task.type === 'table') {
							// Render tabell for √•pningsbalanse
							taskContent = `
								<div class="task-header">
									<h4>${task.title}</h4>
									<span class="task-toggle" id="toggle-${i}">‚ñº</span>
								</div>
								<div class="task-details" id="task-${i}" style="display: none;">
									<p style="margin-bottom: 1rem;">${task.desc}</p>
									<table class="balance-table">
										<thead>
											<tr>
												<th>Konto</th>
												<th>Beskrivelse</th>
												<th style="text-align: right;">Bel√∏p (NOK)</th>
											</tr>
										</thead>
										<tbody>
											${task.tableData.map(row => `
												<tr class="${row.account === '' ? 'separator-row' : ''}">
													<td><strong>${row.account}</strong></td>
													<td>${row.description}</td>
													<td style="text-align: right;">${row.amount}</td>
												</tr>
											`).join('')}
										</tbody>
									</table>
									<p style="margin-top: 1rem; padding: 0.75rem; background: #fff9e6; border-left: 4px solid #ffc107; border-radius: 8px; font-size: 0.9rem;">
										<strong>üí° Tips:</strong> Balansen m√• g√• i null. Debet (eiendeler) = Kredit (egenkapital + gjeld)
									</p>
								</div>
							`;
						} else {
							// Vanlig tekst-oppgave
							taskContent = `
								<div class="task-header">
									<h4>${task.title}</h4>
									<span class="task-toggle" id="toggle-${i}">‚ñº</span>
								</div>
								<div class="task-details" id="task-${i}" style="display: none;">
									<p>${task.desc}</p>
								</div>
							`;
						}
						
						return `
							<div class="task-item collapsible" onclick="toggleTask(${i})">
								<div class="task-number">${i + 1}</div>
								<div class="task-content">
									${taskContent}
								</div>
							</div>
						`;
					}).join('')}
				</div>
            `;

            // Add choices if they exist
            if (session.choices.length > 0) {
                html += `
                    <div class="choices-section">
                        <h3>üí° Velg din strategi</h3>
                        ${session.choices.map(choice => `
                            <div class="choice-item" onclick="selectChoice('${choice.letter}')">
                                <div class="choice-header">
                                    <div class="choice-letter">${choice.letter}</div>
                                    <div class="choice-title">${choice.title}</div>
                                </div>
                                <div class="choice-details">${choice.desc}</div>
                            </div>
                        `).join('')}
                        <button class="submit-btn" id="submitBtn" onclick="submitChoice()" disabled>
                            Bekreft valg
                        </button>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            contentDiv.classList.remove('hidden');
        }
		
		function calculateBalance() {
			let balance = 250000; // Startbalanse fra √•pningsbalanse (oppgave 1)
			
			// Legg til √∏kt 1 resultat hvis det finnes
			if (currentPlayer.session1Amount !== undefined && currentPlayer.session1Amount !== null) {
				balance += currentPlayer.session1Amount;
			}
			
			// Legg til √∏kt 2 resultat hvis det finnes
			if (currentPlayer.session2Amount !== undefined && currentPlayer.session2Amount !== null) {
				balance += currentPlayer.session2Amount;
			}
			
			return balance;
		}

		function updateBalanceDisplay() {
			const balance = calculateBalance();
			const balanceElement = document.getElementById('balanceAmount');
			
			if (balanceElement) {
				balanceElement.textContent = balance.toLocaleString('no-NO') + ' NOK';
				
				// Fargekoding basert p√• om det er over/under startverdi
				if (balance > 250000) {
					balanceElement.style.color = '#28a745'; // Gr√∏nn
				} else if (balance < 250000) {
					balanceElement.style.color = '#dc3545'; // R√∏d
				} else {
					balanceElement.style.color = '#00A651'; // Standard
				}
			}
		}		

        // Get result for a choice - fetches outcome from Sheets (set by admin)
        function getResultForChoice(sessionNum, choice) {
			const sessionKey = `session${sessionNum}`;
			const resultsForSession = RESULTS[sessionKey];
			
			if (!resultsForSession || !resultsForSession[choice]) {
				return null;
			}

			const outcomeKey = `session${sessionNum}Outcome`;
			const outcomeType = currentPlayer[outcomeKey];
			
			const amountKey = `session${sessionNum}Amount`;
			const actualAmount = currentPlayer[amountKey];  
			
			if (outcomeType && actualAmount !== undefined) {
				// Admin har satt outcome og bel√∏p - bruk det
				const outcomes = resultsForSession[choice];
				const result = outcomes[outcomeType];
				
				// 
				return {
					...result,
					amount: actualAmount
				};
			}

			// Ikke satt enn√•
			return {
				icon: '‚è≥',
				title: choice === 'A' ? resultsForSession.A.success.title : resultsForSession.B.success.title,
				narrative: 'Resultatet blir publisert snart! Admin jobber med √• beregne utfallene.',
				amount: 0,
				booking: 'Venter p√• resultat fra admin...'
			};
		}

        let selectedChoice = null;

        function selectChoice(letter) {
            selectedChoice = letter;
            
            // Update UI
            document.querySelectorAll('.choice-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Enable submit button
            document.getElementById('submitBtn').disabled = false;
        }

        function submitChoice() {
			if (!selectedChoice) return;

			const confirmed = confirm(`Er du sikker p√• at du vil velge alternativ ${selectedChoice}?\n\nDu kan ikke endre valget ditt senere!`);
			if (!confirmed) return;

			const submitBtn = document.getElementById('submitBtn');
			submitBtn.disabled = true;
			submitBtn.textContent = '‚è≥ Lagrer...';

			//
			jsonpRequest(SHEETS_API_URL, {
				action: 'saveChoice',
				company: currentPlayer.company,
				session: currentPlayer.currentSession,
				choice: selectedChoice
			})
			.then(() => {
				currentPlayer[`session${currentPlayer.currentSession}Choice`] = selectedChoice;
				currentPlayer[`session${currentPlayer.currentSession}ChoiceTime`] = new Date().toISOString();

				alert(`‚úÖ Valg ${selectedChoice} registrert!\n\nDu kan n√• fortsette √• jobbe med oppgavene frem til √∏kten stenger.`);
				
				document.querySelectorAll('.choice-item').forEach(item => {
					item.style.opacity = '0.6';
					item.style.pointerEvents = 'none';
				});
				submitBtn.textContent = '‚úÖ Valg registrert';
			})
			.catch(error => {
				console.error('Feil ved lagring av valg:', error);
				alert('‚ö†Ô∏è Kunne ikke lagre valg. Pr√∏v igjen!');
				submitBtn.disabled = false;
				submitBtn.textContent = 'Bekreft valg';
			});
		}

        function startCountdown(sessionNum) {
            const deadline = DEADLINES[sessionNum];
            const container = document.getElementById('countdownContainer');
            const timerDisplay = document.getElementById('countdownTimer');

            countdownInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = deadline - now;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerDisplay.textContent = '00:00:00';
                    container.classList.add('warning');
                    
                    // Hide session content with fade out
                    const contentDiv = document.getElementById('sessionContent');
                    contentDiv.classList.add('hidden');
                    
                    setTimeout(() => {
                        showWaitingScreen(sessionNum);
                    }, 500);
                    return;
                }

                // Calculate time
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                timerDisplay.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Warning when less than 5 minutes
                if (timeLeft < 5 * 60 * 1000) {
                    container.classList.add('warning');
                }
            }, 1000);
        }

        function showWaitingScreen(sessionNum) {
            const contentDiv = document.getElementById('sessionContent');
            
            let message = '';
            if (sessionNum === 1) {
                message = `
                    <h2>üéâ √òkt 1 er stengt!</h2>
                    <p>Takk for innsatsen! Vi jobber n√• med √• beregne resultatene.</p>
                    <p>Resultatet av ditt valg vil vises n√•r du starter √∏kt 2.</p>
                    <div class="status">
                        </strong> Ta en pause, men kom tilbake n√•r √∏kt 2 √•pner!
                    </div>
                `;
            } else if (sessionNum === 2) {
                message = `
                    <h2>üéâ √òkt 2 er stengt!</h2>
                    <p>Flott jobbet!.</p>
                    <p>Resultatet vises i √∏kt 3 - siste runde!</p>
                    <div class="status">
                    </div>
                `;
            } else {
                message = `
                    <h2>üèÅ Spillet er ferdig!</h2>
                    <p>Du har fullf√∏rt alle tre √∏kter - flott jobbet!</p>
                    <p>Resultater og leaderboard blir publisert n√•r alle er ferdige og vi har rettet oppgavene.</p>
                    <div class="status">
                        <strong>üèÜ Takk for deltakelsen!</strong>
                    </div>
                `;
            }

            contentDiv.innerHTML = `<div class="waiting-screen">${message}</div>`;
            contentDiv.classList.remove('hidden');
        }

        function logout() {
            if (confirm('Er du sikker p√• at du vil logge ut?')) {
                localStorage.removeItem('suppa_current_player');
                window.location.href = 'suppa-express.html';
            }
        }
		
		function toggleTask(index) {
			const details = document.getElementById(`task-${index}`);
			const toggle = document.getElementById(`toggle-${index}`);
			
			if (details.style.display === 'none') {
				details.style.display = 'block';
				toggle.classList.add('open');
			} else {
				details.style.display = 'none';
				toggle.classList.remove('open');
			}
		}

		async function loadLeaderboard() {
    try {
        const data = await jsonpRequest(SHEETS_API_URL, { action: 'getAllPlayers' });
        if (data.status === 'success') {
            displayLeaderboard(data.players);
        }
    } catch (error) {
        console.error('Feil ved lasting av leaderboard:', error);
    }
}

function displayLeaderboard(players) {
    const container = document.getElementById('leaderboard');
    const validPlayers = players.filter(p => p.name && p.company);
    
    if (validPlayers.length === 0) {
        container.innerHTML = '<p>Ingen spillere enn√•.</p>';
        return;
    }
    
    const sorted = [...validPlayers].sort((a, b) => (b.totalBalance || 250000) - (a.totalBalance || 250000));
    
    let html = '';
    sorted.forEach((player, index) => {
        const rank = index + 1;
        const isTop3 = rank <= 3;
        const isMe = player.company === currentPlayer?.company;
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
        const balance = player.totalBalance || 250000;
        
        html += `
            <div class="leaderboard-item ${isTop3 ? 'top3' : ''} ${isMe ? 'me' : ''}">
                <div class="leaderboard-rank">${medal || rank}</div>
                <div class="leaderboard-info">
                    <strong>${player.name}</strong>
                    <small>${player.company}</small>
                </div>
                <div class="leaderboard-points">${balance.toLocaleString('no-NO')} kr</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

		loadLeaderboard();
		setInterval(loadLeaderboard, 30000);

		function toggleLeaderboard() {
    document.getElementById('leaderboardSticky').classList.toggle('open');
}

async function loadLeaderboard() {
    try {
        const data = await jsonpRequest(SHEETS_API_URL, { action: 'getAllPlayers' });
        if (data.status === 'success') {
            displayLeaderboard(data.players);
        }
    } catch (error) {
        console.error('Feil ved lasting av leaderboard:', error);
    }
}

function displayLeaderboard(players) {
    const validPlayers = players.filter(p => p.name && p.company);
    
    if (validPlayers.length === 0) return;
    
    const sorted = [...validPlayers].sort((a, b) => (b.totalBalance || 250000) - (a.totalBalance || 250000));
    
    // Mini-bar: Vis #1 og din plassering
    const leader = sorted[0];
    const myIndex = sorted.findIndex(p => p.company === currentPlayer?.company);
    const myRank = myIndex + 1;
    const myBalance = sorted[myIndex]?.totalBalance || 250000;
    
    document.getElementById('leaderboardLeader').textContent = 
        `#1 ${leader.name} (${(leader.totalBalance || 250000).toLocaleString('no-NO')} kr)`;
    document.getElementById('leaderboardYou').textContent = 
        `Du: #${myRank} (${myBalance.toLocaleString('no-NO')} kr)`;
    
    // Full liste
    let html = '';
    sorted.forEach((player, index) => {
        const rank = index + 1;
        const isTop3 = rank <= 3;
        const isMe = player.company === currentPlayer?.company;
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
        const balance = player.totalBalance || 250000;
        
        html += `
            <div class="leaderboard-item ${isTop3 ? 'top3' : ''} ${isMe ? 'me' : ''}">
                <div class="leaderboard-rank">${medal || rank}</div>
                <div class="leaderboard-info">
                    <strong>${player.name}</strong>
                    <small>${player.company}</small>
                </div>
                <div class="leaderboard-points">${balance.toLocaleString('no-NO')} kr</div>
            </div>
        `;
    });
    
    document.getElementById('leaderboardFull').innerHTML = html;
}

		function showWelcomePopup() {
    // Vis bare for nye spillere (√∏kt 1, ingen valg gjort)
    if (currentPlayer.currentSession === 1 && !localStorage.getItem('suppa_welcomed_' + currentPlayer.company)) {
        document.getElementById('welcomeOverlay').style.display = 'flex';
    }
}

function closeWelcome() {
    document.getElementById('welcomeOverlay').style.display = 'none';
    localStorage.setItem('suppa_welcomed_' + currentPlayer.company, 'true');
}
		
    </script>
</body>
</html>
